{"componentChunkName":"component---src-templates-blog-post-js","path":"/google-tagmanager-cookie-consent-using-google-tag-manager/","webpackCompilationHash":"1427e0ae21ec65c33f0f","result":{"data":{"site":{"siteMetadata":{"title":"Kriskodira Blog","author":"KrisKodira"}},"markdownRemark":{"id":"71445257-91d2-506e-88ac-614650f462ec","excerpt":"Some annoying client asked you to add a Cookie Consent to his page because of the new GDPR rule in germany where you are only allowed to load tracking cookies…","html":"<p>Some annoying client asked you to add a Cookie Consent to his page because of the new GDPR rule in germany where you are only allowed to load tracking cookies if the user actively says “Yes”?</p>\n<p><strong>Don’t be scared I got your back!</strong></p>\n<p><strong>Glossary:</strong></p>\n<p>GTM —> Google Tag Manager</p>\n<h2>Google Tag Manager</h2>\n<p>Head to <a href=\"https://tagmanager.google.com\">Google Tag Manager</a> and log in with the Google Account you use for your work. Once you’re logged in click on “Create Account” and fill in the data accordingly and choose “Web” at the target platform. Click on create and accept the GTM Policy. Also add the two snippets GTM provides you with to the according places.</p>\n<h2>Creating the Tag</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 658px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0256e621368a23f1adaf3f9c4da04801/6164f/add-new-tag.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.49544072948328%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABuUlEQVQoz4VSTY/TMBDdP8SJX8WBXwM/AHFBQty7e0Cc9orggNgmW9o0m4+2qWPHzped+O047jZstYKRniYzjp9n3sxV2/Uw2qPvPYzxvrtE57xGr80E7f5vW7Rth0oq8EriCmSitROGEai1xUFZWMo7XJq1lh7UVAARUzye8lLVT4QWv3YWn34MuF4OiDnwbTVSbKD0TDSO/up6vcZiscD1zQ2+vn+Hh48fgDSBpMq5qHyFSikUTEDIBoJe4UIizBRKQW3wElrPzJxzsLJEJQT42zeoXr+C+fIZyp2V3BMWRYHVfYjN+g8e4hjxdovDLp18luWkUXsmlFKipgIaypV0bx9FTgfIupk1zPMcm02ELREkSYKXzSvqyB2pcmga9MPwXMOBEsYYP2FqTbvpUWyMz7vzv+G0PMPFp/y5wq7rJo0G42EH53uMxq9S18/r9LRKl99unRjpd245EsAtSZFUwM+cJlkC31NgX+O/1lDbrtpDcaQh0pTdQPKixDZnyPYMUcaQkl+nDDHlOE2UMfYy6Kw4HqehJmnmKwzuV7hbBgjCAMtg9uHJ/17+G+7uXRBidyho7RQeAYLeRnq/Qpw/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"add new tag\"\n        title=\"add new tag\"\n        data-src=\"/static/0256e621368a23f1adaf3f9c4da04801/6164f/add-new-tag.png\"\n        data-srcset=\"/static/0256e621368a23f1adaf3f9c4da04801/5039d/add-new-tag.png 250w,\n/static/0256e621368a23f1adaf3f9c4da04801/d19c0/add-new-tag.png 500w,\n/static/0256e621368a23f1adaf3f9c4da04801/6164f/add-new-tag.png 658w\"\n        sizes=\"(max-width: 658px) 100vw, 658px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Create a new Tag by clicking on “Add a new tag” on the upper left side and then click on the tag manager to select a tag type. In the tag type you choose “Custom HTML”. Here you can paste your tracker Script from Google Analytics, Matomo and so on.</p>\n<p>At the top left corner give your tag a meaningful name like “GA Tracker”. Skip the trigger selection for now and click on save and click “Add trigger” if GTM tells you that you didn’t create a trigger now.</p>\n<p>Next up go to Triggers and click on “New” to create a trigger. Click on the trigger configuration to select a trigger type and here you will select “Custom Event”.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/54e11a63ccd040a28a524fbcc8adc046/edb7e/trigger-config.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.08492569002123%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABQ0lEQVQoz51Sa2+DMBDr//+V+zCpWwXkTcgL7xwe3aRW2xrJoBDis313sdZBKYVhHDFOE3LOqLWi/AelorYGH2ZcnPcIS0ZKG9G6ri+BK8xCOMujjW8IzsA69zJp6wrDRgh3Q81J7JZ+cFQ81l/IiEDLZDU+gNZLKedPKTOGdGb6G/Hdcoz9ItlJKNf6IYPmnmjtTvho/SD0oi4KKUElSTj5PrJ8Zvs5oVgOtG1Mb7v2Bdbavl+W5czokaqHlknGWZwm1VUWac4RgdK6z+iRLWeOAti8rdBWrLbvhPJgQ3iZDeCPtBtFHZU65/dLrZ9HjplkunIadtTdwdkUqjHG9kZwkYCDzkJUdEQ2p4oPJcpDgUvo0FGIMnbCiItSGlry4ntT5DpYQItqgnvvHUbt8H7TuA4Gn5MXOFxHh0G+M7pJOL4ALTetduk8GpIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"trigger config\"\n        title=\"trigger config\"\n        data-src=\"/static/54e11a63ccd040a28a524fbcc8adc046/e11df/trigger-config.png\"\n        data-srcset=\"/static/54e11a63ccd040a28a524fbcc8adc046/5039d/trigger-config.png 250w,\n/static/54e11a63ccd040a28a524fbcc8adc046/d19c0/trigger-config.png 500w,\n/static/54e11a63ccd040a28a524fbcc8adc046/e11df/trigger-config.png 1000w,\n/static/54e11a63ccd040a28a524fbcc8adc046/8e846/trigger-config.png 1500w,\n/static/54e11a63ccd040a28a524fbcc8adc046/edb7e/trigger-config.png 1884w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Once you got that open enter a meaningful name to your event name like “cookieConsented”. You will push that event later on in your JS once the client says “Yes, I want to be tracked”. Also click the “Some Custom Events” radio and exclude your development environment from being tracked by checking if the hostname <strong>does not</strong> contain your dev environment names like staging, localhost and so on. Otherwise you would track clicks and so on in your dev environment which the client doesn’t want. Give your trigger a meaningful name like “Cookie has been consented”. After this save and continue with the tutorial.</p>\n<h2>Adding the trigger to the tag</h2>\n<p>Go back to “Tags” and click on your tag you just created. After that click on “Triggering” and choose the Trigger you just created. Click on “Save” and lets move to the code.</p>\n<h2>The Cookie Consent Code</h2>\n<h4>HTML &#x26; SASS (CSS)</h4>\n<p>Add the HTML to your page. It could look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;div class=&quot;cookie-dim&quot;&gt;\n  &lt;div class=&quot;cookie-consent&quot;&gt;\n    &lt;div class=&quot;text-wrap&quot;&gt;\n      &lt;p&gt;\n      We use cookies to track you do you agree?\n      &lt;/p&gt;\n      &lt;div class=&quot;button&quot; id=&quot;agreeToCookie&quot;&gt;Yes&lt;/div&gt;\n      &lt;div class=&quot;button&quot; id=&quot;disagreeToCookie&quot;&gt;No and close window&lt;/div&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n&lt;/div&gt;</code></pre></div>\n<p>Some basic SASS styling you could use would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">.cookie-dim\n  width: 100vw\n  height: 100vh\n  background-color: #00000065\n  position: fixed\n  top: 0\n  left: 0\n  \n  .cookie-consent\n    width: 40vw\n    background-color: #fff\n    padding: 4rem\n    margin: 0 auto\n    position: absolute\n    left: 0\n    right: 0\n    top: 50%\n    transform: translateY(-50%)\n  \n  .button\n    padding: 1rem\n    background-color: #000\n    color: #fff\n    display: inline-block\n    text-align: center\n    min-width: 6rem\n    cursor: pointer\n    &amp;:first-of-type\n      margin-right: 1rem\n    &amp;:hover\n      background-color: #272727</code></pre></div>\n<p>Your cookie consent will now look like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9935fa33ca3a48312040a47b8527f17e/05af3/cookie-overlay.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.256175663311986%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABq0lEQVQoz5WSy4vSYRSGv8VAFjQa3XRGB6NaFMGsZtNmiHAhbScQIiIyNyqiZgiuZhaKIOINr5OQP0NmGJp0kkBcCIIb/w53miKICy9P/T5oOVQHHs63OOd93w+OcDqduFwu3G436jscDlMqlcjlcuTz+UvJZrMkk0kSiYQklUqRTqcRSrVKtfoFRVEol8tSrFAoUCwW/4o6q/LHRA0h3r97y5vXr/j4wc9wOGQymfwT4/GY6XTKYDCQQVRB1UQYtFfRbQie7j5itVrxvzWbzahUKlJM/Zkwm3fQ373N82f7/ByNeHlwgM1mw+FwYLVasVgsBINB1us1i8WC5XIpu4pao987mUyGeDwuk4qdx0+4ab7PvvWFHKidnHJ6dka9Xuf4+JN0brfblyacz+eEQiF8Ph+xWAxhevAQg/keu3t7KPkMP2oVmic1GvVzmhd1mt8v+Hb+FaXymX6/T6/Xo9Vq0el06Ha7NBoN/H6/xOv1Ira3DZhMRraMRsy3rnNHCG5c2UCn06LXatBc07Cp3WTLoOfw6IhAIIDdbpcn5vF4ZLJIJCLPLRqN8gvsocUL7BmefgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"cookie overlay\"\n        title=\"cookie overlay\"\n        data-src=\"/static/9935fa33ca3a48312040a47b8527f17e/e11df/cookie-overlay.png\"\n        data-srcset=\"/static/9935fa33ca3a48312040a47b8527f17e/5039d/cookie-overlay.png 250w,\n/static/9935fa33ca3a48312040a47b8527f17e/d19c0/cookie-overlay.png 500w,\n/static/9935fa33ca3a48312040a47b8527f17e/e11df/cookie-overlay.png 1000w,\n/static/9935fa33ca3a48312040a47b8527f17e/8e846/cookie-overlay.png 1500w,\n/static/9935fa33ca3a48312040a47b8527f17e/d40c8/cookie-overlay.png 2000w,\n/static/9935fa33ca3a48312040a47b8527f17e/05af3/cookie-overlay.png 2186w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Once you think you like your cookie style add the <em>display: none</em> styling to your <em>.cookie-dim</em> class.</p>\n<h4>Javascript</h4>\n<p>Now create a .js file for your cookie consent that is saved in your js folder. It could be named something like <em>cookie-consent.js</em>.</p>\n<p>First we need to check if the user has already decided that he wants/doesn’t want us to load the cookies. You can do this by adding the following <em>if</em> condition (Make sure to use this code after the Page has been loaded and the document is ready):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    if(document.cookie.indexOf(&quot;cookieDesicionHasBeenMade=&quot;) === 0){\n \t    // code       \n    }</code></pre></div>\n<p>The complete code for the cookie consent will look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    var loadCookies = function(){\n      window.dataLayer = window.dataLayer || [];\n      window.dataLayer.push({&#39;cookieConsented&#39;: true});\n    }\n\n    if(document.cookie.indexOf(&quot;cookieDesicionHasBeenMade=&quot;) === -1){\n      const cookieDim = document.querySelector(&quot;.cookie-dim&quot;);\n      const today = new Date();\n      const twoWeeks = today.setDate(today.getDate() + 14).toString();\n      const cookieVars = &quot;cookieDesicionHasBeenMade=true; expires=&quot;+twoWeeks+&quot;; path=/&quot;;\n      \n      cookieDim.style.display = &quot;block&quot;;\n\n      document.getElementById(&quot;agreeToCookie&quot;).addEventListener(&quot;click&quot;, function () {  \n        cookieDim.style.display = &quot;none&quot;;\n\n        loadCookies();\n        document.cookie = cookieVars;\n        document.cookie = &quot;allowTrackingCookies=true; expires=&quot;+twoWeeks+&quot;; path=/&quot;;;\n      })\n\n      document.getElementById(&quot;disagreeToCookie&quot;).addEventListener(&quot;click&quot;, function () {  \n        cookieDim.style.display = &quot;none&quot;;\n        document.cookie = cookieVars;\n      })\n    }\n\n    if(document.cookie.indexOf(&quot;allowTrackingCookies=&quot;) !== -1){\n      loadCookies();\n    }</code></pre></div>\n<h2>Testing your configuration</h2>\n<p>Go back to GTM and click on Submit in the upper right corner. This is pretty much like Version control. Add a meaningful name to your version like “Add cookie consent” and click on “Publish”. Once published click on “Preview”. Go to your webpage and you will see thet GTM console popping up all of a sudden.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1000px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8946d6374b2602a1e4cd2eb5d6727d3a/f1791/tag-not-fired.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.482686253934943%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABIklEQVQY032QT0+DQBDFORut38diT6bfkAVKeqzhoMGexHpUD0aKlYRSeml68qKUAgvln89lI4aDcZJf3mR230xmBHU0woihaRrEcxG93gmGwws4jgPDMKDrOkzTRDfyPMd4PIaqqtzbRVBkAlmWoSgKBmIfp8dHGPTPcD+b8SEyIbicTBCGIdI0RZZlCIKAN5MkiXsJIb8qWIsllq4L1/NxZ97CuL7CdHqDp8cH2HMLbwsb1sszXu05ttstNpsNZ71ew/M8uMy7Wq24+r4PYU9zfNU1InrALilQ/6xVs1pZVowSVVVxmlVbmnpRFDzvqrDbBTyJaYb3jwifYYwo2jMiTtxqHCNJEq7/ITSTmziw20T7EJQmDMppGvxF+97+6eo3wamgO5+SKoQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"tag not fired\"\n        title=\"tag not fired\"\n        data-src=\"/static/8946d6374b2602a1e4cd2eb5d6727d3a/e11df/tag-not-fired.png\"\n        data-srcset=\"/static/8946d6374b2602a1e4cd2eb5d6727d3a/5039d/tag-not-fired.png 250w,\n/static/8946d6374b2602a1e4cd2eb5d6727d3a/d19c0/tag-not-fired.png 500w,\n/static/8946d6374b2602a1e4cd2eb5d6727d3a/e11df/tag-not-fired.png 1000w,\n/static/8946d6374b2602a1e4cd2eb5d6727d3a/8e846/tag-not-fired.png 1500w,\n/static/8946d6374b2602a1e4cd2eb5d6727d3a/d40c8/tag-not-fired.png 2000w,\n/static/8946d6374b2602a1e4cd2eb5d6727d3a/f1791/tag-not-fired.png 3812w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>As you can see below the “Tags not fired” headline, none of the tags we created are being fired. Which is exactly what you want. Now once you click “Yes” you will see the Tracker you added jump to “Tags fired on this page”. Right now your tracker is loaded inside the website and working. Now whenever you change the page your cookie should still be laoded all the time. If you want to test the deny option just open your website in a private browser, click “No” and see what happens. Your tracker stays in “Not Fired On This Page” forever. No matter what you do. <strong>TADA!</strong> There we have it. Now we only need to give the user the ability to revoke his choice in the privacy policy. But this one is easy peasy.</p>\n<h2>Making the consented cookie revokeable</h2>\n<p>In your privacy policy create a link with an anchor called something like <em>#</em>revokecookieconsent.</p>\n<p>Now after your document has been loaded in your JS add the following snippet:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">const revokeConsentLink = document.querySelector(&quot;a[href=&#39;#revokecookieconsent&#39;]&quot;);\n\nif(revokeConsentLink != null){\n  revokeConsentLink.addEventListener(&quot;click&quot;, function () { \n    document.cookie = &#39;allowTrackingCookies=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/&#39;;\n    document.cookie = &#39;cookieDesicionHasBeenMade=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/&#39;; \n  })\n}</code></pre></div>\n<p>Once you click the link in the privacy policy it deletes the cookies and the decision is revoked. Now when the user changes the page he is presented with the cookie consent again and he can decide not to be tracked. You should also keep in mind to disable the overlay for the Privacy Policy and all the Legal information with a SASS (CSS) style. Just give your Privacy Policy page and your Legal Information page a class on the body and hide the dim there with some css.</p>\n<h2>Thats its!</h2>\n<p>Now you should be safe with the new GDPR rule. Keep in mind that I’m not legally responsive if you still get striked and the rule changes again. This is just a tip on my side how to handle this new rule.</p>","frontmatter":{"title":"Google Tagmanager: Cookie Consent using Google Tag Manager","date":"16.11.2019","category":"Code","description":"How to let your users choose if they want to be tracked.","featured_post":true,"picture":"charles-Ms9xBg3Gtr8-unsplash.jpg"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/google-tagmanager-cookie-consent-using-google-tag-manager/"}}}